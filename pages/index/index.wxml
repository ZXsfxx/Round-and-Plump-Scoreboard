<view class="page-container">
  <!-- å›ºå®šåœ¨é¡¶éƒ¨çš„åŒºåŸŸ -->
  <view class="fixed-header">
    <view class="total-score-container">
      <view class="score-container">
        <text class="team-name">å¾è€å¸ˆ</text>
        <view class="score-box total">
          <text class="score">{{team1Score}}</text>
        </view>
      </view>
      <text class="vs">VS</text>
      <view class="score-container">
        <text class="team-name">ç‹è€å¸ˆ</text>
        <view class="score-box total">
          <text class="score">{{team2Score}}</text>
        </view>
      </view>
    </view>

    <view class="daily-scores-header">
      <text class="header-text">æ¯æ—¥æ¯”åˆ†</text>
    </view>
    
    <view class="edit-buttons-container">
      <button class="edit-button search {{isLoadingCalendar ? 'loading' : ''}}" bindtap="showCalendar">
        <text class="button-text">{{isLoadingCalendar ? 'åŠ è½½ä¸­...' : 'çƒ­åŠ›å›¾ï¼'}}</text>
        <view class="button-loading" wx:if="{{isLoadingCalendar}}"></view>
      </button>
      <button class="edit-button note" bindtap="showNoteEditor">åœ†æ»šæ»šç§˜å¯†åŸºåœ°ï¼</button>
    </view>
  </view>
  
  <!-- å¯æ»šåŠ¨çš„æ—¥æœŸæ¯”åˆ†åŒºåŸŸ -->
  <scroll-view id="scrollView" class="scrollable-content" scroll-y="true" enhanced="true" show-scrollbar="true" bounces="true" scroll-top="{{scrollTop}}">
    <!-- æ·»åŠ é¡¶éƒ¨ç©ºç™½ç¡®ä¿ç¬¬ä¸€ä¸ªé¡¹ç›®å®Œå…¨æ˜¾ç¤º -->
    <view class="top-space"></view>
    
    <view class="daily-scores-list">
      <block wx:if="{{dailyScores.length > 0}}">
        <view class="daily-score-item {{item.highlight ? 'highlight' : ''}}" wx:for="{{dailyScores}}" wx:key="date" bindlongpress="showDeleteConfirm" data-date="{{item.date}}" data-id="{{item._id}}">
          <text class="date-text">{{item.date}}</text>
          <view class="daily-score-values">
            <view class="score-box small" bindtap="showScorePicker" data-index="{{index}}" data-team="team1">
              <text class="score">{{item.team1}}</text>
            </view>
            <text class="vs small">VS</text>
            <view class="score-box small" bindtap="showScorePicker" data-index="{{index}}" data-team="team2">
              <text class="score">{{item.team2}}</text>
            </view>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="empty-state">
          <text class="empty-text">æš‚æ— æ—¥æœŸæ¯”åˆ†ï¼Œè¯·ç‚¹å‡»"æ·»åŠ æ—¥æœŸ"æŒ‰é’®æ·»åŠ </text>
        </view>
      </block>
    </view>
    
    <!-- æ·»åŠ åº•éƒ¨å¡«å……ç©ºé—´ -->
    <view class="bottom-space"></view>
  </scroll-view>

  <!-- æ·»åŠ æµ®åŠ¨æŒ‰é’® -->
  <view class="fab-button {{isLoadingDate ? 'loading' : ''}}" bindtap="showDatePicker" data-mode="add">
    <text class="fab-icon" wx:if="{{!isLoadingDate}}">+</text>
    <view class="fab-loading" wx:if="{{isLoadingDate}}"></view>
  </view>

  <!-- æ¨¡æ€æ¡†å’Œé€‰æ‹©å™¨ -->
  <view class="picker-mask" wx:if="{{pickerVisible}}" bindtap="hidePicker"></view>
  <view class="picker-container" wx:if="{{pickerVisible}}">
    <picker-view class="picker" value="{{pickerValue}}" bindchange="{{editingIndex >= 0 ? 'onDailyScoreChange' : 'onPickerChange'}}">
      <picker-view-column>
        <view wx:for="{{pickerRange}}" wx:key="*this" class="picker-item">{{item}}</view>
      </picker-view-column>
    </picker-view>
  </view>

  <view class="date-picker-mask" wx:if="{{datePickerVisible}}" bindtap="hideDatePicker"></view>
  <view class="date-picker-container" wx:if="{{datePickerVisible}}">
    <view class="date-picker-title">{{editMode === 'add' ? 'æ·»åŠ æ—¥æœŸ' : 'æœç´¢æ—¥æœŸ'}}</view>
    <view class="date-picker-content">
      <picker-view class="date-picker" value="{{dateValue}}" bindchange="onDatePickerChange">
        <block wx:if="{{editMode === 'add'}}">
          <picker-view-column>
            <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}å¹´</view>
          </picker-view-column>
          <picker-view-column>
            <view wx:for="{{months}}" wx:key="*this" class="picker-item">{{item}}æœˆ</view>
          </picker-view-column>
          <picker-view-column>
            <view wx:for="{{days}}" wx:key="*this" class="picker-item">{{item}}æ—¥</view>
          </picker-view-column>
        </block>
        <block wx:else>
          <picker-view-column>
            <view wx:for="{{searchableYears}}" wx:key="*this" class="picker-item">{{item}}å¹´</view>
          </picker-view-column>
          <picker-view-column>
            <view wx:for="{{searchableMonths}}" wx:key="*this" class="picker-item">{{item}}æœˆ</view>
          </picker-view-column>
          <picker-view-column>
            <view wx:for="{{searchableDays}}" wx:key="*this" class="picker-item">{{item}}æ—¥</view>
          </picker-view-column>
        </block>
      </picker-view>
    </view>
    <view class="date-picker-buttons">
      <button class="cancel-button" bindtap="hideDatePicker">å–æ¶ˆ</button>
      <button class="confirm-button" bindtap="{{editMode === 'add' ? 'addDailyScore' : 'searchDate'}}">
        {{editMode === 'add' ? 'æ·»åŠ ' : 'æœç´¢'}}
      </button>
    </view>
  </view>

  <!-- æ—¥å†çƒ­åŠ›å›¾æ¨¡æ€æ¡† -->
  <view class="calendar-modal-mask" wx:if="{{calendarVisible}}" bindtap="hideCalendar"></view>
  <view class="calendar-modal" wx:if="{{calendarVisible}}" catchtap>
    <calendar id="calendar" dailyScores="{{dailyScores}}" bind:daytap="onCalendarDayTap"></calendar>
  </view>

  <!-- ç¬”è®°ç¼–è¾‘å™¨ -->
  <view class="note-editor-mask" wx:if="{{noteEditorVisible}}" bindtap="hideNoteEditor"></view>
  <view class="note-editor-container" wx:if="{{noteEditorVisible}}" catchtap>
    <view class="note-editor-header">
      <text class="note-editor-title">åœ†åœ†æ»šæ»šç»„åˆçš„ç§˜å¯†åŸºåœ°ï¼</text>
      <view class="note-editor-close" catchtap="hideNoteEditor">Ã—</view>
    </view>

    <!-- ç¬”è®°ç±»å‹é€‰æ‹© -->
    <view class="note-tabs">
      <view class="note-tab {{activeNoteTab === 'all' ? 'active' : ''}}" bindtap="switchNoteTab" data-tab="all">å…¨éƒ¨</view>
      <view class="note-tab {{activeNoteTab === 'text' ? 'active' : ''}}" bindtap="switchNoteTab" data-tab="text">æ–‡æœ¬</view>
      <view class="note-tab {{activeNoteTab === 'photo' ? 'active' : ''}}" bindtap="switchNoteTab" data-tab="photo">ç…§ç‰‡</view>
    </view>

    <!-- ç¬”è®°åˆ—è¡¨ -->
    <scroll-view class="notes-list" scroll-y wx:if="{{!isEditingNote}}">
      <view wx:if="{{isLoadingNote}}" class="loading-container">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
        <view class="loading-progress"></view>
      </view>
      
      <block wx:elif="{{notesList.length > 0}}">
        <view class="note-card" 
              wx:for="{{notesList}}" 
              wx:key="id" 
              bindtap="editNote" 
              data-id="{{item.id}}"
              bindlongpress="showDeleteNoteConfirm"
              data-id="{{item.id}}">
          <view class="note-card-content">
            <view class="note-card-title">{{item.title || 'æ— æ ‡é¢˜ç¬”è®°'}}</view>
            <!-- æ˜¾ç¤ºç¬”è®°å—ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡å‰çš„å†…å®¹ -->
            <block wx:for="{{item.blocks}}" 
                   wx:key="index" 
                   wx:for-item="block" 
                   wx:for-index="blockIndex"
                   wx:if="{{blockIndex <= item.firstImageIndex || (item.firstImageIndex === -1 && block.type === 'text')}}">
              <text wx:if="{{block.type === 'text'}}" class="note-card-text">{{block.content}}</text>
              <image wx:if="{{block.type === 'image'}}" 
                     src="{{block.content}}" 
                     mode="widthFix" 
                     class="note-card-image"></image>
            </block>
          </view>
          <view class="note-card-footer">
            <text class="note-card-time">åˆ›å»ºäºï¼š{{item.createTime}}</text>
            <text class="note-card-time" wx:if="{{item.updateTime !== item.createTime}}">æ›´æ–°äºï¼š{{item.updateTime}}</text>
          </view>
        </view>
      </block>
      
      <view wx:else class="empty-notes">
        <text>æš‚æ— ç¬”è®°ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»º</text>
      </view>
    </scroll-view>
    
    <!-- æ·»åŠ ç¬”è®°æŒ‰é’®ï¼ˆå›ºå®šä½ç½®ï¼‰ -->
    <view class="add-note-btn-fixed" bindtap="createNewNote" wx:if="{{!isEditingNote}}">
      <text class="add-icon">+</text>
    </view>

    <!-- ç¬”è®°ç¼–è¾‘åŒºåŸŸ -->
    <view class="note-edit-area" wx:if="{{isEditingNote}}">
      <input class="note-title-input" 
             value="{{currentNote.title}}" 
             bindinput="onNoteTitleChange" 
             placeholder="è¾“å…¥æ ‡é¢˜..."
             maxlength="50" />
             
      <scroll-view class="note-blocks-container" scroll-y>
        <block wx:for="{{currentNote.blocks}}" wx:key="index">
          <!-- æ–‡æœ¬å— -->
          <view class="note-block" wx:if="{{item.type === 'text'}}">
            <textarea class="note-text-block"
                      value="{{item.content}}" 
                      bindinput="onTextBlockChange"
                      data-index="{{index}}"
                      bindfocus="onTextBlockFocus"
                      placeholder="{{index === 0 ? 'åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„ç§˜å¯†...' : 'ç»§ç»­å†™ä¸‹å»...'}}"
                      maxlength="5000"
                      auto-height></textarea>
          </view>
          
          <!-- å›¾ç‰‡å— -->
          <view class="note-block" wx:if="{{item.type === 'image'}}">
            <view class="image-block">
              <image src="{{item.content}}" 
                     mode="widthFix" 
                     class="block-image"
                     bindtap="previewImage"
                     data-url="{{item.content}}"></image>
              <view class="image-actions">
                <view class="delete-image-btn" 
                      catchtap="deleteBlock" 
                      data-index="{{index}}">Ã—</view>
              </view>
            </view>
          </view>
        </block>
      </scroll-view>
      
      <!-- åº•éƒ¨å·¥å…·æ  -->
      <view class="note-edit-footer">
        <view class="note-tools">
          <view class="tool-btn" bindtap="chooseImage">
            <text class="tool-icon">ğŸ–¼</text>
          </view>
        </view>
        <view class="note-actions">
          <button class="note-btn cancel" bindtap="cancelEdit">è¿”å›</button>
          <button class="save-note-btn {{isSaving ? 'saving' : ''}}" bindtap="saveNote">
            <text class="save-text">{{isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}</text>
            <view class="save-icon" wx:if="{{isSaving}}"></view>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
  <view class="image-preview-modal" wx:if="{{isPreviewingImage}}" catchtap="hideImagePreview">
    <swiper class="preview-swiper" current="{{previewImageIndex}}" bindchange="onPreviewSwiperChange">
      <swiper-item wx:for="{{currentNote.images}}" wx:key="*this">
        <image src="{{item}}" mode="aspectFit" class="preview-large-image" bindtap="stopPropagation"></image>
      </swiper-item>
    </swiper>
    <view class="preview-indicator">{{previewImageIndex + 1}}/{{currentNote.images.length}}</view>
  </view>
</view> 